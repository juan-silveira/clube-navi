// ==========================================
// TENANT DATABASE SCHEMA
// ==========================================
// Cada tenant tem seu próprio database com este schema
// Dados de usuários, produtos, transações isolados por tenant

generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma-tenant"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("TENANT_DATABASE_URL")
}

// ==========================================
// USERS
// ==========================================

model User {
  id        String    @id @default(uuid()) @db.Uuid
  firstName String    @map("first_name") @db.VarChar(100)
  lastName  String    @map("last_name") @db.VarChar(100)
  email     String    @unique @db.VarChar(255)
  username  String    @unique @db.VarChar(50)
  cpf       String    @unique @db.VarChar(14)
  phone     String?   @db.VarChar(20)
  birthDate DateTime? @map("birth_date") @db.Date

  // Authentication
  password          String    @db.VarChar(255)
  passwordChangedAt DateTime? @map("password_changed_at") @db.Timestamptz(6)

  // Profile
  profilePicture String?         @map("profile_picture") @db.VarChar(500)
  userType       UserType        @map("user_type")
  merchantStatus MerchantStatus? @map("merchant_status")

  // Blockchain (nullable até a confirmação de email)
  publicKey  String? @unique @map("public_key") @db.VarChar(42)
  privateKey String? @map("private_key") @db.VarChar(255)

  // Referral (nullable se usuário não tem código)
  referralId String? @unique @map("referral_id") @db.VarChar(20)
  referredBy String? @map("referred_by") @db.VarChar(20)

  // Geolocation (para push por CEP)
  address Json?

  // Status
  isActive      Boolean       @default(true) @map("is_active")
  accountStatus AccountStatus @default(active) @map("account_status")
  lastLoginAt   DateTime?     @map("last_login_at") @db.Timestamptz(6)

  // Security
  emailConfirmed         Boolean   @default(false) @map("email_confirmed")
  failedLoginAttempts    Int       @default(0) @map("failed_login_attempts")
  lastFailedLoginAt      DateTime? @map("last_failed_login_at") @db.Timestamptz(6)
  isBlockedLoginAttempts Boolean   @default(false) @map("is_blocked_login_attempts")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  products       Product[]
  purchases      Purchase[]          @relation("ConsumerPurchases")
  sales          Purchase[]          @relation("MerchantSales")
  pushTokens     UserPushToken[]
  notifications  Notification[]
  userModules    UserModule[]
  cashbackConfig UserCashbackConfig?

  @@index([email])
  @@index([username])
  @@index([cpf])
  @@index([referralId])
  @@index([userType])
  @@index([isActive])
  @@map("users")
}

// ==========================================
// USER MODULES (Controle Individual)
// ==========================================

model UserModule {
  id        String  @id @default(uuid()) @db.Uuid
  userId    String  @map("user_id") @db.Uuid
  moduleKey String  @map("module_key") @db.VarChar(50)
  isEnabled Boolean @map("is_enabled")

  reason     String? @db.Text
  enabledBy  String? @map("enabled_by") @db.Uuid
  disabledBy String? @map("disabled_by") @db.Uuid

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, moduleKey])
  @@index([userId])
  @@index([moduleKey])
  @@map("user_modules")
}

// ==========================================
// CASHBACK CONFIG (Individual por Usuário)
// ==========================================

model UserCashbackConfig {
  id     String @id @default(uuid()) @db.Uuid
  userId String @unique @map("user_id") @db.Uuid

  // Percentuais customizados (soma deve ser 100%)
  consumerPercent         Decimal @map("consumer_percent") @db.Decimal(5, 2)
  clubPercent             Decimal @map("club_percent") @db.Decimal(5, 2)
  consumerReferrerPercent Decimal @map("consumer_referrer_percent") @db.Decimal(5, 2)
  merchantReferrerPercent Decimal @map("merchant_referrer_percent") @db.Decimal(5, 2)

  // Audit
  reason       String?  @db.Text
  configuredBy String?  @map("configured_by") @db.Uuid
  configuredAt DateTime @default(now()) @map("configured_at") @db.Timestamptz(6)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_cashback_configs")
}

// ==========================================
// PUSH TOKENS
// ==========================================

model UserPushToken {
  id     String @id @default(uuid()) @db.Uuid
  userId String @map("user_id") @db.Uuid

  token    String   @unique @db.VarChar(255)
  platform Platform
  isActive Boolean  @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([platform])
  @@map("user_push_tokens")
}

// ==========================================
// PRODUCTS
// ==========================================

model Product {
  id         String @id @default(uuid()) @db.Uuid
  merchantId String @map("merchant_id") @db.Uuid

  name               String  @db.VarChar(255)
  description        String  @db.Text
  price              Decimal @db.Decimal(10, 2)
  cashbackPercentage Decimal @map("cashback_percentage") @db.Decimal(5, 2)

  imageUrl String? @map("image_url") @db.VarChar(500)
  category String? @db.VarChar(100)

  stock    Int     @default(0)
  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  merchant  User       @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  purchases Purchase[]

  @@index([merchantId])
  @@index([isActive])
  @@index([category])
  @@map("products")
}

// ==========================================
// PURCHASES
// ==========================================

model Purchase {
  id         String @id @default(uuid()) @db.Uuid
  consumerId String @map("consumer_id") @db.Uuid
  merchantId String @map("merchant_id") @db.Uuid
  productId  String @map("product_id") @db.Uuid

  totalAmount         Decimal @map("total_amount") @db.Decimal(10, 2)
  merchantAmount      Decimal @map("merchant_amount") @db.Decimal(10, 2)
  consumerCashback    Decimal @map("consumer_cashback") @db.Decimal(10, 2)
  platformFee         Decimal @map("platform_fee") @db.Decimal(10, 2)
  consumerReferrerFee Decimal @map("consumer_referrer_fee") @db.Decimal(10, 2)
  merchantReferrerFee Decimal @map("merchant_referrer_fee") @db.Decimal(10, 2)

  status PurchaseStatus @default(pending)
  txHash String?        @map("tx_hash") @db.VarChar(66)

  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  completedAt DateTime? @map("completed_at") @db.Timestamptz(6)

  consumer User    @relation("ConsumerPurchases", fields: [consumerId], references: [id])
  merchant User    @relation("MerchantSales", fields: [merchantId], references: [id])
  product  Product @relation(fields: [productId], references: [id])

  @@index([consumerId])
  @@index([merchantId])
  @@index([productId])
  @@index([status])
  @@index([createdAt])
  @@map("purchases")
}

// ==========================================
// CAMPAIGNS (Push Notifications)
// ==========================================

model Campaign {
  id String @id @default(uuid()) @db.Uuid

  title  String         @db.VarChar(255)
  body   String         @db.Text
  type   CampaignType
  status CampaignStatus @default(draft)

  // Targeting
  targetAll     Boolean @default(false) @map("target_all")
  targetUserIds Json?   @map("target_user_ids") @db.Json
  targetCep     String? @map("target_cep") @db.VarChar(10)

  // Action
  actionUrl String? @map("action_url") @db.VarChar(500)

  // Stats
  totalSent    Int @default(0) @map("total_sent")
  totalOpened  Int @default(0) @map("total_opened")
  totalClicked Int @default(0) @map("total_clicked")

  // Scheduling
  scheduledFor DateTime? @map("scheduled_for") @db.Timestamptz(6)
  sentAt       DateTime? @map("sent_at") @db.Timestamptz(6)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([status])
  @@index([scheduledFor])
  @@map("campaigns")
}

// ==========================================
// NOTIFICATIONS
// ==========================================

model Notification {
  id     String @id @default(uuid()) @db.Uuid
  userId String @map("user_id") @db.Uuid

  type    NotificationType
  title   String           @db.VarChar(255)
  message String           @db.Text

  isRead Boolean   @default(false) @map("is_read")
  readAt DateTime? @map("read_at") @db.Timestamptz(6)

  actionUrl String? @map("action_url") @db.VarChar(500)
  metadata  Json?

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

// ==========================================
// ENUMS
// ==========================================

enum UserType {
  consumer
  merchant
}

enum MerchantStatus {
  pending
  approved
  rejected
  suspended
}

enum AccountStatus {
  active
  suspended
  blocked
  deleted
}

enum Platform {
  ios
  android
  web
}

enum PurchaseStatus {
  pending
  processing
  completed
  failed
  refunded
}

enum CampaignType {
  push
  sms
  whatsapp
  email
}

enum CampaignStatus {
  draft
  scheduled
  sending
  sent
  failed
  cancelled
}

enum NotificationType {
  purchase
  cashback
  referral
  system
  promotion
}
