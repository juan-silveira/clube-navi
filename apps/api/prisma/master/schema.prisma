// ==========================================
// MASTER DATABASE SCHEMA
// ==========================================
// Banco de dados central que gerencia todos os clubs
// Cada club tem seu próprio database isolado

generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma-master"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("MASTER_DATABASE_URL")
}

// ==========================================
// CLUB MANAGEMENT
// ==========================================

model Club {
  id                String    @id @default(uuid()) @db.Uuid
  slug              String    @unique @db.VarChar(50)
  companyName       String    @map("company_name") @db.VarChar(255)
  companyDocument   String    @unique @map("company_document") @db.VarChar(18)
  status            ClubStatus @default(trial)

  // Database connection
  databaseHost      String    @map("database_host") @db.VarChar(255)
  databasePort      Int       @default(5432) @map("database_port")
  databaseName      String    @map("database_name") @db.VarChar(100)
  databaseUser      String    @map("database_user") @db.VarChar(100)
  databasePassword  String    @map("database_password") @db.VarChar(255)

  // URLs
  subdomain         String?   @unique @db.VarChar(50)
  customDomain      String?   @unique @map("custom_domain") @db.VarChar(255)
  adminSubdomain    String?   @unique @map("admin_subdomain") @db.VarChar(50)

  // Limits
  maxUsers          Int       @default(1000) @map("max_users")
  maxAdmins         Int       @default(10) @map("max_admins")
  maxStorageGB      Int       @default(50) @map("max_storage_gb")

  // Billing & Subscription
  subscriptionPlan     SubscriptionPlan   @default(BASIC) @map("subscription_plan")
  subscriptionStatus   SubscriptionStatus @default(TRIAL) @map("subscription_status")
  monthlyFee           Decimal            @default(0) @map("monthly_fee") @db.Decimal(10, 2)

  // Datas de cobrança
  trialEndsAt          DateTime?          @map("trial_ends_at") @db.Timestamptz(6)
  nextBillingDate      DateTime?          @map("next_billing_date") @db.Timestamptz(6)
  lastBillingDate      DateTime?          @map("last_billing_date") @db.Timestamptz(6)

  // Controle financeiro
  totalBilled          Decimal            @default(0) @map("total_billed") @db.Decimal(15, 2)
  outstandingBalance   Decimal            @default(0) @map("outstanding_balance") @db.Decimal(15, 2)

  // Contact
  contactName       String    @map("contact_name") @db.VarChar(255)
  contactEmail      String    @map("contact_email") @db.VarChar(255)
  contactPhone      String    @map("contact_phone") @db.VarChar(20)

  // Metadata
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  branding          ClubBranding?
  modules           ClubModule[]
  admins            ClubAdmin[]
  apiKeys           ClubApiKey[]
  usageStats        ClubUsageStats[]
  stats             ClubStats?
  cashbackConfig    ClubCashbackConfig?
  withdrawalConfig  ClubWithdrawalConfig?
  notifications     Notification[]

  @@index([slug])
  @@index([subdomain])
  @@index([status])
  @@index([subscriptionStatus], map: "idx_clubs_subscription_status")
  @@map("clubs")
}

// ==========================================
// CLUB BRANDING
// ==========================================

model ClubBranding {
  id                String   @id @default(uuid()) @db.Uuid
  clubId          String   @unique @map("club_id") @db.Uuid

  // Logos
  logoUrl           String?  @map("logo_url") @db.VarChar(500)
  logoIconUrl       String?  @map("logo_icon_url") @db.VarChar(500)
  faviconUrl        String?  @map("favicon_url") @db.VarChar(500)

  // Colors
  primaryColor      String   @default("#3B82F6") @map("primary_color") @db.VarChar(7)
  secondaryColor    String   @default("#10B981") @map("secondary_color") @db.VarChar(7)
  accentColor       String   @default("#F59E0B") @map("accent_color") @db.VarChar(7)
  backgroundColor   String   @default("#FFFFFF") @map("background_color") @db.VarChar(7)
  textColor         String   @default("#1F2937") @map("text_color") @db.VarChar(7)

  // App Info
  appName           String   @map("app_name") @db.VarChar(100)
  appDescription    String?  @map("app_description") @db.Text
  appStoreUrl       String?  @map("app_store_url") @db.VarChar(500)
  playStoreUrl      String?  @map("play_store_url") @db.VarChar(500)

  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  club            Club   @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@map("club_brandings")
}

// ==========================================
// MODULES SYSTEM
// ==========================================

model ClubModule {
  id                String    @id @default(uuid()) @db.Uuid
  clubId          String    @map("club_id") @db.Uuid
  moduleKey         ModuleKey @map("module_key")
  isEnabled         Boolean   @default(true) @map("is_enabled")
  isEnabledByDefault Boolean  @default(true) @map("is_enabled_by_default")

  config            Json?     @default("{}")
  displayName       String    @map("display_name") @db.VarChar(100)
  description       String?   @db.Text
  sortOrder         Int       @default(0) @map("sort_order")

  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  club            Club    @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@unique([clubId, moduleKey])
  @@index([clubId])
  @@index([isEnabled])
  @@map("club_modules")
}

// ==========================================
// ANALYTICS & STATISTICS
// ==========================================

model ClubStats {
  id                    String    @id @default(uuid()) @db.Uuid
  clubId              String    @unique @map("club_id") @db.Uuid

  // Usuários
  totalUsers            Int       @default(0) @map("total_users")
  totalConsumers        Int       @default(0) @map("total_consumers")
  totalMerchants        Int       @default(0) @map("total_merchants")
  activeUsers30d        Int       @default(0) @map("active_users_30d")

  // Transações
  totalPurchases        Int       @default(0) @map("total_purchases")
  totalRevenue          Decimal   @default(0) @map("total_revenue") @db.Decimal(15, 2)
  totalCashbackPaid     Decimal   @default(0) @map("total_cashback_paid") @db.Decimal(15, 2)
  totalPlatformFees     Decimal   @default(0) @map("total_platform_fees") @db.Decimal(15, 2)

  // Produtos
  totalProducts         Int       @default(0) @map("total_products")

  // Métricas de período (30 dias)
  revenue30d            Decimal   @default(0) @map("revenue_30d") @db.Decimal(15, 2)
  purchases30d          Int       @default(0) @map("purchases_30d")
  cashback30d           Decimal   @default(0) @map("cashback_30d") @db.Decimal(15, 2)

  createdAt             DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  club                Club    @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@index([clubId])
  @@map("club_stats")
}

model GlobalStats {
  id                    String    @id @default(uuid()) @db.Uuid
  date                  DateTime  @unique @db.Date

  // Totais globais
  totalClubs          Int       @default(0) @map("total_clubs")
  totalUsers            Int       @default(0) @map("total_users")
  totalConsumers        Int       @default(0) @map("total_consumers")
  totalMerchants        Int       @default(0) @map("total_merchants")
  totalPurchases        Int       @default(0) @map("total_purchases")
  totalRevenue          Decimal   @default(0) @map("total_revenue") @db.Decimal(15, 2)
  totalCashbackPaid     Decimal   @default(0) @map("total_cashback_paid") @db.Decimal(15, 2)
  totalPlatformFees     Decimal   @default(0) @map("total_platform_fees") @db.Decimal(15, 2)
  totalProducts         Int       @default(0) @map("total_products")

  // Métricas de 30 dias
  activeUsers30d        Int       @default(0) @map("active_users_30d")
  revenue30d            Decimal   @default(0) @map("revenue_30d") @db.Decimal(15, 2)
  purchases30d          Int       @default(0) @map("purchases_30d")
  cashback30d           Decimal   @default(0) @map("cashback_30d") @db.Decimal(15, 2)

  // Crescimento
  newClubs            Int       @default(0) @map("new_clubs")
  newUsers              Int       @default(0) @map("new_users")
  churnedClubs        Int       @default(0) @map("churned_clubs")

  createdAt             DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([date])
  @@map("global_stats")
}

// ==========================================
// CASHBACK CONFIGURATION
// ==========================================

model ClubCashbackConfig {
  id                        String   @id @default(uuid()) @db.Uuid
  clubId                  String   @unique @map("club_id") @db.Uuid

  // Percentuais padrão (soma deve ser 100%)
  consumerPercent           Decimal  @default(50.0) @map("consumer_percent") @db.Decimal(5, 2)
  clubPercent               Decimal  @default(25.0) @map("club_percent") @db.Decimal(5, 2)
  consumerReferrerPercent   Decimal  @default(12.5) @map("consumer_referrer_percent") @db.Decimal(5, 2)
  merchantReferrerPercent   Decimal  @default(12.5) @map("merchant_referrer_percent") @db.Decimal(5, 2)

  createdAt                 DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                 DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  club                    Club   @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@map("club_cashback_configs")
}

model ClubWithdrawalConfig {
  id                   String   @id @default(uuid()) @db.Uuid
  clubId             String   @unique @map("club_id") @db.Uuid

  // Taxa sobre saques
  withdrawalFeePercent Decimal  @default(2.5) @map("withdrawal_fee_percent") @db.Decimal(5, 2)
  withdrawalFeeFixed   Decimal  @default(0) @map("withdrawal_fee_fixed") @db.Decimal(10, 2)
  minWithdrawalAmount  Decimal  @default(50) @map("min_withdrawal_amount") @db.Decimal(10, 2)

  createdAt            DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  club               Club   @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@map("club_withdrawal_configs")
}

// ==========================================
// ADMINS
// ==========================================

model ClubAdmin {
  id                String    @id @default(uuid()) @db.Uuid
  clubId          String    @map("club_id") @db.Uuid

  name              String    @db.VarChar(255)
  email             String    @db.VarChar(255)
  password          String    @db.VarChar(255)
  role              AdminRole @default(admin)

  isActive          Boolean   @default(true) @map("is_active")
  lastLoginAt       DateTime? @map("last_login_at") @db.Timestamptz(6)

  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  club            Club    @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@unique([clubId, email])
  @@index([clubId])
  @@index([email])
  @@map("club_admins")
}

model SuperAdmin {
  id                String    @id @default(uuid()) @db.Uuid
  name              String    @db.VarChar(255)
  email             String    @unique @db.VarChar(255)
  password          String    @db.VarChar(255)

  permissions       Json      @default("[]")
  isActive          Boolean   @default(true) @map("is_active")
  lastLoginAt       DateTime? @map("last_login_at") @db.Timestamptz(6)

  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("super_admins")
}

// ==========================================
// API KEYS & USAGE
// ==========================================

model ClubApiKey {
  id                String    @id @default(uuid()) @db.Uuid
  clubId          String    @map("club_id") @db.Uuid

  keyName           String    @map("key_name") @db.VarChar(100)
  apiKey            String    @unique @map("api_key") @db.VarChar(64)
  isActive          Boolean   @default(true) @map("is_active")
  lastUsedAt        DateTime? @map("last_used_at") @db.Timestamptz(6)

  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  expiresAt         DateTime? @map("expires_at") @db.Timestamptz(6)

  club            Club    @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@index([clubId])
  @@index([apiKey])
  @@map("club_api_keys")
}

model ClubUsageStats {
  id                String   @id @default(uuid()) @db.Uuid
  clubId          String   @map("club_id") @db.Uuid
  date              DateTime @db.Date

  apiCalls          Int      @default(0) @map("api_calls")
  storageUsedMB     Int      @default(0) @map("storage_used_mb")
  activeUsers       Int      @default(0) @map("active_users")

  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  club            Club   @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@unique([clubId, date])
  @@index([clubId])
  @@index([date])
  @@map("club_usage_stats")
}

// ==========================================
// NOTIFICATIONS (Push Notifications)
// ==========================================

model Notification {
  id                String              @id @default(uuid()) @db.Uuid
  clubId            String?             @map("club_id") @db.Uuid

  // Tipo e destinatários
  notificationType  NotificationType    @map("notification_type")
  targetType        NotificationTarget  @map("target_type")
  targetClubIds     String[]            @map("target_club_ids")

  // Conteúdo
  title             String              @db.VarChar(255)
  message           String              @db.Text
  data              Json?               @default("{}")

  // Estatísticas de envio
  totalSent         Int                 @default(0) @map("total_sent")
  totalDelivered    Int                 @default(0) @map("total_delivered")
  totalFailed       Int                 @default(0) @map("total_failed")
  totalClicked      Int                 @default(0) @map("total_clicked")

  // Status e timestamp
  status            NotificationStatus  @default(pending)
  scheduledFor      DateTime?           @map("scheduled_for") @db.Timestamptz(6)
  sentAt            DateTime?           @map("sent_at") @db.Timestamptz(6)

  // Metadados
  sentBy            String              @map("sent_by") @db.Uuid // ID do SuperAdmin
  errorLog          Json?               @map("error_log") @default("[]")

  createdAt         DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)

  club              Club?               @relation(fields: [clubId], references: [id], onDelete: SetNull)

  @@index([clubId])
  @@index([status])
  @@index([notificationType])
  @@index([sentAt])
  @@index([scheduledFor])
  @@map("notifications")
}

// ==========================================
// ENUMS
// ==========================================

enum ClubStatus {
  trial
  active
  suspended
  cancelled
  expired
}

enum SubscriptionPlan {
  BASIC       // Até 1.000 usuários - R$ 500/mês
  PRO         // Até 10.000 usuários - R$ 2.000/mês
  ENTERPRISE  // Ilimitado - R$ 5.000/mês
}

enum SubscriptionStatus {
  TRIAL       // 30 dias grátis
  ACTIVE      // Pagando normalmente
  PAST_DUE    // Atraso no pagamento
  SUSPENDED   // Suspenso por falta de pagamento
  CANCELED    // Cancelado pelo club
}

enum ModuleKey {
  marketplace
  internet
  cinema
  telemedicine
  giftcards
  insurance
  streaming
  referrals
  cashback
  telecom
}

enum AdminRole {
  admin
  manager
  support
}

enum NotificationType {
  push_notification
  email
  sms
  in_app
}

enum NotificationTarget {
  all_clubs
  specific_clubs
  active_clubs
  trial_clubs
  suspended_clubs
}

enum NotificationStatus {
  pending
  scheduled
  sending
  sent
  failed
  cancelled
}
