generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma-tenant"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("TENANT_DATABASE_URL")
}

model User {
  id                     String                @id @default(uuid()) @db.Uuid
  firstName              String                @map("first_name") @db.VarChar(100)
  lastName               String                @map("last_name") @db.VarChar(100)
  email                  String                @unique @db.VarChar(255)
  username               String                @unique @db.VarChar(50)
  cpf                    String                @unique @db.VarChar(14)
  phone                  String?               @db.VarChar(20)
  birthDate              DateTime?             @map("birth_date") @db.Date
  password               String                @db.VarChar(255)
  passwordChangedAt      DateTime?             @map("password_changed_at") @db.Timestamptz(6)
  profilePicture         String?               @map("profile_picture") @db.VarChar(500)
  userType               UserType              @map("user_type")
  merchantStatus         MerchantStatus?       @map("merchant_status")
  publicKey              String?               @unique @map("public_key") @db.VarChar(42)
  privateKey             String?               @map("private_key") @db.VarChar(255)
  referralId             String?               @unique @map("referral_id") @db.VarChar(20)
  referredBy             String?               @map("referred_by") @db.VarChar(20)
  address                Json?
  isActive               Boolean               @default(true) @map("is_active")
  accountStatus          AccountStatus         @default(active) @map("account_status")
  lastLoginAt            DateTime?             @map("last_login_at") @db.Timestamptz(6)
  emailConfirmed         Boolean               @default(false) @map("email_confirmed")
  failedLoginAttempts    Int                   @default(0) @map("failed_login_attempts")
  lastFailedLoginAt      DateTime?             @map("last_failed_login_at") @db.Timestamptz(6)
  isBlockedLoginAttempts Boolean               @default(false) @map("is_blocked_login_attempts")
  createdAt              DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime              @updatedAt @map("updated_at") @db.Timestamptz(6)
  analyticsEvents        AnalyticsEvent[]
  groups                 GroupUser[]
  notifications          Notification[]
  products               Product[]
  purchases              Purchase[]            @relation("ConsumerPurchases")
  sales                  Purchase[]            @relation("MerchantSales")
  pushNotificationLogs   PushNotificationLog[]
  cashbackConfig         UserCashbackConfig?
  userModules            UserModule[]
  pushTokens             UserPushToken[]
  userRoles              UserRole[]
  sessions               UserSession[]

  @@index([email])
  @@index([username])
  @@index([cpf])
  @@index([referralId])
  @@index([userType])
  @@index([isActive])
  @@map("users")
}

model UserModule {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  moduleKey  String   @map("module_key") @db.VarChar(50)
  isEnabled  Boolean  @map("is_enabled")
  reason     String?
  enabledBy  String?  @map("enabled_by") @db.Uuid
  disabledBy String?  @map("disabled_by") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, moduleKey])
  @@index([userId])
  @@index([moduleKey])
  @@map("user_modules")
}

model UserCashbackConfig {
  id                      String   @id @default(uuid()) @db.Uuid
  userId                  String   @unique @map("user_id") @db.Uuid
  consumerPercent         Decimal  @map("consumer_percent") @db.Decimal(5, 2)
  clubPercent             Decimal  @map("club_percent") @db.Decimal(5, 2)
  consumerReferrerPercent Decimal  @map("consumer_referrer_percent") @db.Decimal(5, 2)
  merchantReferrerPercent Decimal  @map("merchant_referrer_percent") @db.Decimal(5, 2)
  reason                  String?
  configuredBy            String?  @map("configured_by") @db.Uuid
  configuredAt            DateTime @default(now()) @map("configured_at") @db.Timestamptz(6)
  createdAt               DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt               DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_cashback_configs")
}

model UserPushToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique @db.VarChar(255)
  platform  Platform
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([platform])
  @@map("user_push_tokens")
}

model Product {
  id                 String     @id @default(uuid()) @db.Uuid
  merchantId         String     @map("merchant_id") @db.Uuid
  name               String     @db.VarChar(255)
  description        String
  price              Decimal    @db.Decimal(10, 2)
  cashbackPercentage Decimal    @map("cashback_percentage") @db.Decimal(5, 2)
  imageUrl           String?    @map("image_url") @db.VarChar(500)
  category           String?    @db.VarChar(100)
  stock              Int        @default(0)
  isActive           Boolean    @default(true) @map("is_active")
  createdAt          DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime   @updatedAt @map("updated_at") @db.Timestamptz(6)
  merchant           User       @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  purchases          Purchase[]

  @@index([merchantId])
  @@index([isActive])
  @@index([category])
  @@map("products")
}

model Purchase {
  id                  String         @id @default(uuid()) @db.Uuid
  consumerId          String         @map("consumer_id") @db.Uuid
  merchantId          String         @map("merchant_id") @db.Uuid
  productId           String         @map("product_id") @db.Uuid
  totalAmount         Decimal        @map("total_amount") @db.Decimal(10, 2)
  merchantAmount      Decimal        @map("merchant_amount") @db.Decimal(10, 2)
  consumerCashback    Decimal        @map("consumer_cashback") @db.Decimal(10, 2)
  platformFee         Decimal        @map("platform_fee") @db.Decimal(10, 2)
  consumerReferrerFee Decimal        @map("consumer_referrer_fee") @db.Decimal(10, 2)
  merchantReferrerFee Decimal        @map("merchant_referrer_fee") @db.Decimal(10, 2)
  status              PurchaseStatus @default(pending)
  txHash              String?        @map("tx_hash") @db.VarChar(66)
  createdAt           DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  completedAt         DateTime?      @map("completed_at") @db.Timestamptz(6)
  consumer            User           @relation("ConsumerPurchases", fields: [consumerId], references: [id])
  merchant            User           @relation("MerchantSales", fields: [merchantId], references: [id])
  product             Product        @relation(fields: [productId], references: [id])

  @@index([consumerId])
  @@index([merchantId])
  @@index([productId])
  @@index([status])
  @@index([createdAt])
  @@map("purchases")
}

model Campaign {
  id            String         @id @default(uuid()) @db.Uuid
  title         String         @db.VarChar(255)
  body          String
  type          CampaignType
  status        CampaignStatus @default(draft)
  targetAll     Boolean        @default(false) @map("target_all")
  targetUserIds Json?          @map("target_user_ids") @db.Json
  targetCep     String?        @map("target_cep") @db.VarChar(10)
  actionUrl     String?        @map("action_url") @db.VarChar(500)
  totalSent     Int            @default(0) @map("total_sent")
  totalOpened   Int            @default(0) @map("total_opened")
  totalClicked  Int            @default(0) @map("total_clicked")
  scheduledFor  DateTime?      @map("scheduled_for") @db.Timestamptz(6)
  sentAt        DateTime?      @map("sent_at") @db.Timestamptz(6)
  createdAt     DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([status])
  @@index([scheduledFor])
  @@map("campaigns")
}

model Notification {
  id        String           @id @default(uuid()) @db.Uuid
  userId    String           @map("user_id") @db.Uuid
  type      NotificationType
  title     String           @db.VarChar(255)
  message   String
  isRead    Boolean          @default(false) @map("is_read")
  readAt    DateTime?        @map("read_at") @db.Timestamptz(6)
  actionUrl String?          @map("action_url") @db.VarChar(500)
  metadata  Json?
  createdAt DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model PushNotificationCampaign {
  id              String                @id @default(uuid()) @db.Uuid
  title           String                @db.VarChar(100)
  description     String
  pageTitle       String?               @map("page_title") @db.VarChar(100)
  pageDescription String?               @map("page_description")
  code            String?               @db.VarChar(50)
  rules           String?
  logoUrl         String?               @map("logo_url") @db.VarChar(255)
  bannerUrl       String?               @map("banner_url") @db.VarChar(255)
  enableButton    Boolean               @default(false) @map("enable_button")
  buttonType      String?               @map("button_type") @db.VarChar(20)
  targetModule    String?               @map("target_module") @db.VarChar(50)
  externalLink    String?               @map("external_link") @db.VarChar(500)
  buttonText      String?               @map("button_text") @db.VarChar(50)
  geolocation     Json?
  targetUserIds   Json?                 @map("target_user_ids") @db.Json
  targetUserCount Int                   @default(0) @map("target_user_count")
  sentCount       Int                   @default(0) @map("sent_count")
  failedCount     Int                   @default(0) @map("failed_count")
  status          PushCampaignStatus    @default(draft)
  createdBy       String                @map("created_by") @db.Uuid
  createdAt       DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  completedAt     DateTime?             @map("completed_at") @db.Timestamptz(6)
  scheduledAt     DateTime?             @map("scheduled_at") @db.Timestamptz(6)
  logs            PushNotificationLog[]

  @@index([status])
  @@index([createdBy])
  @@index([scheduledAt])
  @@map("push_notification_campaigns")
}

model PushNotificationLog {
  id         String                   @id @default(uuid()) @db.Uuid
  campaignId String                   @map("campaign_id") @db.Uuid
  userId     String                   @map("user_id") @db.Uuid
  pushToken  String                   @map("push_token") @db.VarChar(500)
  status     PushNotificationStatus   @default(pending)
  error      String?
  sentAt     DateTime                 @map("sent_at") @db.Timestamptz(6)
  clickedAt  DateTime?                @map("clicked_at") @db.Timestamptz(6)
  openedAt   DateTime?                @map("opened_at") @db.Timestamptz(6)
  campaign   PushNotificationCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user       User                     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("push_notification_logs")
}

model AnalyticsEvent {
  id         String             @id @default(uuid()) @db.Uuid
  userId     String?            @map("user_id") @db.Uuid
  sessionId  String?            @map("session_id") @db.Uuid
  eventType  AnalyticsEventType @map("event_type")
  eventName  String             @map("event_name") @db.VarChar(100)
  category   String?            @db.VarChar(50)
  pagePath   String?            @map("page_path") @db.VarChar(500)
  pageTitle  String?            @map("page_title") @db.VarChar(200)
  referrer   String?            @db.VarChar(500)
  metadata   Json?
  platform   String?            @db.VarChar(50)
  deviceType String?            @map("device_type") @db.VarChar(50)
  browser    String?            @db.VarChar(50)
  os         String?            @db.VarChar(50)
  ipAddress  String?            @map("ip_address") @db.VarChar(45)
  country    String?            @db.VarChar(2)
  city       String?            @db.VarChar(100)
  createdAt  DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  user       User?              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([eventType])
  @@index([eventName])
  @@index([createdAt])
  @@index([sessionId])
  @@map("analytics_events")
}

model UserSession {
  id             String    @id @default(uuid()) @db.Uuid
  userId         String?   @map("user_id") @db.Uuid
  sessionToken   String    @unique @map("session_token") @db.VarChar(255)
  startedAt      DateTime  @default(now()) @map("started_at") @db.Timestamptz(6)
  lastActivityAt DateTime  @default(now()) @map("last_activity_at") @db.Timestamptz(6)
  endedAt        DateTime? @map("ended_at") @db.Timestamptz(6)
  duration       Int?      @default(0)
  platform       String?   @db.VarChar(50)
  deviceType     String?   @map("device_type") @db.VarChar(50)
  browser        String?   @db.VarChar(50)
  os             String?   @db.VarChar(50)
  ipAddress      String?   @map("ip_address") @db.VarChar(45)
  pageViews      Int       @default(0) @map("page_views")
  interactions   Int       @default(0)
  user           User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@index([startedAt])
  @@map("user_sessions")
}

model Role {
  id          String           @id @default(uuid()) @db.Uuid
  name        String           @unique @db.VarChar(50)
  displayName String           @map("display_name") @db.VarChar(100)
  description String?
  isSystem    Boolean          @default(false) @map("is_system")
  priority    Int              @default(0)
  createdAt   DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)
  permissions RolePermission[]
  userRoles   UserRole[]

  @@map("roles")
}

model Permission {
  id          String           @id @default(uuid()) @db.Uuid
  module      String           @db.VarChar(50)
  action      PermissionAction
  resource    String           @db.VarChar(100)
  description String?
  createdAt   DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  roles       RolePermission[]

  @@unique([module, action])
  @@map("permissions")
}

model RolePermission {
  id           String     @id @default(uuid()) @db.Uuid
  roleId       String     @map("role_id") @db.Uuid
  permissionId String     @map("permission_id") @db.Uuid
  createdAt    DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model UserRole {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  roleId    String   @map("role_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy String?  @map("created_by") @db.Uuid
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

model Group {
  id          String      @id @default(uuid()) @db.Uuid
  name        String      @db.VarChar(100)
  description String?
  color       String?     @db.VarChar(7)
  createdAt   DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime    @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy   String      @map("created_by") @db.Uuid
  users       GroupUser[]

  @@map("groups")
}

model GroupUser {
  id      String   @id @default(uuid()) @db.Uuid
  groupId String   @map("group_id") @db.Uuid
  userId  String   @map("user_id") @db.Uuid
  addedAt DateTime @default(now()) @map("added_at") @db.Timestamptz(6)
  addedBy String   @map("added_by") @db.Uuid
  group   Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@map("group_users")
}

model WhatsappMessage {
  id               String                @id @default(uuid()) @db.Uuid
  senderUserId     String                @map("sender_user_id") @db.Uuid
  templateId       String?               @map("template_id") @db.VarChar(50)
  message          String
  recipientUserIds Json                  @map("recipient_user_ids") @db.Json
  recipientPhones  Json                  @map("recipient_phones") @db.Json
  status           WhatsappMessageStatus @default(sending)
  successCount     Int                   @default(0) @map("success_count")
  failureCount     Int                   @default(0) @map("failure_count")
  results          Json?                 @db.Json
  sentAt           DateTime              @default(now()) @map("sent_at") @db.Timestamptz(6)

  @@index([senderUserId])
  @@index([sentAt])
  @@index([status])
  @@map("whatsapp_messages")
}

enum UserType {
  consumer
  merchant
  admin
}

enum MerchantStatus {
  pending
  approved
  rejected
  suspended
}

enum AccountStatus {
  active
  suspended
  blocked
  deleted
}

enum Platform {
  ios
  android
  web
}

enum PurchaseStatus {
  pending
  processing
  completed
  failed
  refunded
}

enum CampaignType {
  push
  sms
  whatsapp
  email
}

enum CampaignStatus {
  draft
  scheduled
  sending
  sent
  failed
  cancelled
}

enum NotificationType {
  purchase
  cashback
  referral
  system
  promotion
}

enum PushCampaignStatus {
  draft
  processing
  completed
  failed
  scheduled
}

enum PushNotificationStatus {
  pending
  sent
  failed
  read
}

enum AnalyticsEventType {
  page_view
  click
  form_submit
  purchase
  search
  notification_open
  notification_click
  video_play
  video_complete
  download
  share
  error
  custom
}

enum PermissionAction {
  create
  read
  update
  delete
  execute
}

enum WhatsappMessageStatus {
  sending
  sent
  failed
  partial
}
