generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x"]
  jsonProtocol  = "js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String              @id @default(uuid()) @db.Uuid
  name                   String              @db.VarChar(255)
  email                  String              @unique @db.VarChar(255)
  username               String              @unique @db.VarChar(50)
  cpf                    String              @unique @db.VarChar(14)
  phone                  String?             @db.VarChar(20)
  birthDate              DateTime?           @map("birth_date") @db.Date
  publicKey              String?             @map("public_key")
  privateKey             String?             @map("private_key")
  password               String              @db.VarChar(255)
  passwordChangedAt      DateTime?           @map("password_changed_at") @db.Timestamptz(6)
  isFirstAccess          Boolean             @default(true) @map("is_first_access")
  sessionToken           String?             @unique @map("session_token") @db.VarChar(255)
  sessionExpiresAt       DateTime?           @map("session_expires_at") @db.Timestamptz(6)
  sessionTimeout         Int                 @default(600) @map("session_timeout")
  isActive               Boolean             @default(true) @map("is_active")
  emailConfirmed         Boolean             @default(false) @map("email_confirmed")
  profilePicture         String?             @map("profile_picture")
  blockchainAddress      String?             @map("blockchain_address") @db.VarChar(42)
  metadata               Json?
  lastActivityAt         DateTime?           @map("last_activity_at") @db.Timestamptz(6)
  failedLoginAttempts    Int                 @default(0) @map("failed_login_attempts")
  lastFailedLoginAt      DateTime?           @map("last_failed_login_at") @db.Timestamptz(6)
  isBlockedLoginAttempts Boolean             @default(false) @map("is_blocked_login_attempts")
  createdAt              DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)
  userPlan               UserPlan            @default(BASIC) @map("user_plan")
  backDocument           UserDocumentStatus? @default(not_sent) @map("back_document")
  frontDocument          UserDocumentStatus? @default(not_sent) @map("front_document")
  selfieDocument         UserDocumentStatus? @default(not_sent) @map("selfie_document")
  referralId             String?             @map("referral_id") @db.VarChar(50)
  referralDescription    String?             @map("referral_description") @db.Text
  notifications          Notification[]
  passwordResets         PasswordReset[]
  transactions           Transaction[]
  userActions            UserAction[]
  reviewedDocuments      UserDocument[]      @relation("UserDocumentReviewer")
  userDocuments          UserDocument[]
  userTaxes              UserTaxes?
  userTwoFactors         UserTwoFactor[]
  userBalances           UserBalance[]

  @@index([email], map: "idx_users_email")
  @@index([cpf], map: "idx_users_cpf")
  @@index([isActive], map: "idx_users_active")
  @@index([emailConfirmed], map: "idx_users_email_confirmed")
  @@index([lastActivityAt], map: "idx_users_last_activity")
  @@index([userPlan], map: "idx_users_user_plan")
  @@index([referralId], map: "idx_users_referral_id")
  @@index([username], map: "idx_users_username")
  @@map("users")
}

model Transaction {
  id                      String             @id @default(uuid()) @db.Uuid
  userId                  String?            @map("user_id") @db.Uuid
  transactionType         TransactionType    @map("transaction_type")
  status                  TransactionStatus  @default(pending)
  amount                  Decimal?           @db.Decimal(20, 8)
  currency                String?            @db.VarChar(5)
  txHash                  String?            @map("tx_hash") @db.VarChar(66)
  blockNumber             BigInt?            @map("block_number")
  fromAddress             String?            @map("from_address") @db.VarChar(42)
  toAddress               String?            @map("to_address") @db.VarChar(42)
  confirmedAt             DateTime?          @map("confirmed_at") @db.Timestamptz(6)
  failedAt                DateTime?          @map("failed_at") @db.Timestamptz(6)
  createdAt               DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt               DateTime           @updatedAt @map("updated_at") @db.Timestamptz(6)
  metadata                Json?
  fee                     Decimal?           @default(0) @db.Decimal(15, 2)
  netAmount               Decimal?           @map("net_amount") @db.Decimal(20, 8)
  operationType           String?            @map("operation_type") @db.VarChar(50)
  user                    User?              @relation(fields: [userId], references: [id])

  @@index([userId, transactionType], map: "idx_transactions_user_type")
  @@index([transactionType, status], map: "idx_transactions_type_status")
  @@index([txHash], map: "idx_transactions_tx_hash")
  @@index([createdAt], map: "idx_transactions_created_at")
  @@map("transactions")
}

model Document {
  id             String   @id @default(uuid()) @db.Uuid
  userId         String?  @map("user_id") @db.Uuid
  filename       String   @db.VarChar(255)
  originalName   String   @map("original_name") @db.VarChar(255)
  mimeType       String   @map("mime_type") @db.VarChar(100)
  size           BigInt
  category       String?  @db.VarChar(100)
  tags           Json?    @db.Json
  metadata       Json?
  path           String   @db.VarChar(500)
  url            String?  @db.VarChar(500)
  isPublic       Boolean  @default(false) @map("is_public")
  expiresAt      DateTime? @map("expires_at") @db.Timestamptz(6)
  downloadCount  Int      @default(0) @map("download_count")
  lastDownloadAt DateTime? @map("last_download_at") @db.Timestamptz(6)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([userId], map: "idx_documents_user_id")
  @@index([category], map: "idx_documents_category")
  @@index([expiresAt], map: "idx_documents_expires_at")
  @@map("documents")
}

model UserDocument {
  id              String             @id @default(uuid()) @db.Uuid
  userId          String             @map("user_id") @db.Uuid
  documentType    UserDocumentType   @map("document_type")
  status          UserDocumentStatus @default(not_sent)
  s3Url           String?            @map("s3_url") @db.VarChar(500)
  s3Key           String?            @map("s3_key") @db.VarChar(500)
  filename        String?            @db.VarChar(255)
  mimeType        String?            @map("mime_type") @db.VarChar(100)
  fileSize        BigInt?            @map("file_size")
  rejectionReason String?            @map("rejection_reason")
  reviewedBy      String?            @map("reviewed_by") @db.Uuid
  reviewedAt      DateTime?          @map("reviewed_at") @db.Timestamptz(6)
  uploadedAt      DateTime?          @map("uploaded_at") @db.Timestamptz(6)
  createdAt       DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime           @updatedAt @map("updated_at") @db.Timestamptz(6)
  reviewer        User?              @relation("UserDocumentReviewer", fields: [reviewedBy], references: [id])
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, documentType], name: "user_document_type_unique")
  @@index([userId], map: "idx_user_documents_user_id")
  @@index([status], map: "idx_user_documents_status")
  @@index([documentType], map: "idx_user_documents_type")
  @@index([reviewedBy], map: "idx_user_documents_reviewer")
  @@index([status, documentType], map: "idx_user_documents_status_type")
  @@map("user_documents")
}

model UserTwoFactor {
  id               String        @id @default(uuid()) @db.Uuid
  userId           String        @map("user_id") @db.Uuid
  type             TwoFactorType
  secret           String?
  phoneNumber      String?       @map("phone_number") @db.VarChar(20)
  email            String?       @db.VarChar(255)
  isActive         Boolean       @default(false) @map("is_active")
  isVerified       Boolean       @default(false) @map("is_verified")
  backupCodes      Json?         @map("backup_codes")
  usedBackupCodes  Json          @default("[]") @map("used_backup_codes")
  setupCompletedAt DateTime?     @map("setup_completed_at") @db.Timestamptz(6)
  lastUsedAt       DateTime?     @map("last_used_at") @db.Timestamptz(6)
  failedAttempts   Int           @default(0) @map("failed_attempts")
  lockedUntil      DateTime?     @map("locked_until") @db.Timestamptz(6)
  settings         Json          @default("{}")
  createdAt        DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt        DateTime?     @map("deleted_at") @db.Timestamptz(6)
  user             User          @relation(fields: [userId], references: [id])

  @@unique([userId, type])
  @@index([userId], map: "idx_user_two_factors_user_id")
  @@index([userId, isActive], map: "idx_user_two_factors_user_active")
  @@map("user_two_factors")
}

model EmailTemplate {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique @db.VarChar(100)
  subject     String   @db.VarChar(255)
  htmlContent String   @map("html_content")
  textContent String?  @map("text_content")
  variables   Json?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([name], map: "idx_email_templates_name")
  @@index([isActive], map: "idx_email_templates_active")
  @@map("email_templates")
}

model Notification {
  id         String    @id @default(uuid()) @db.Uuid
  sender     String    @default("coinage") @db.VarChar(50)
  title      String    @db.VarChar(255)
  message    String
  isRead     Boolean   @default(false) @map("is_read")
  isActive   Boolean   @default(true) @map("is_active")
  readDate   DateTime? @map("read_date") @db.Timestamptz(6)
  deleteDate DateTime? @map("delete_date") @db.Timestamptz(6)
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  userId     String    @map("user_id") @db.Uuid
  isFavorite Boolean   @default(false) @map("is_favorite")
  user       User      @relation(fields: [userId], references: [id])

  @@index([userId], map: "idx_notifications_user_id")
  @@index([isActive], map: "idx_notifications_active")
  @@index([isRead], map: "idx_notifications_read")
  @@index([isFavorite], map: "idx_notifications_favorite")
  @@index([createdAt], map: "idx_notifications_created")
  @@map("notifications")
}

model UserAction {
  id           String             @id @default(uuid()) @db.Uuid
  userId       String             @map("user_id") @db.Uuid
  action       UserActionType
  category     UserActionCategory
  status       UserActionStatus   @default(success)
  details      Json?
  metadata     Json?
  relatedId    String?            @map("related_id") @db.Uuid
  relatedType  String?            @map("related_type") @db.VarChar(50)
  ipAddress    String?            @map("ip_address") @db.VarChar(45)
  userAgent    String?            @map("user_agent")
  deviceInfo   Json?              @map("device_info")
  location     Json?
  errorMessage String?            @map("error_message")
  errorCode    String?            @map("error_code") @db.VarChar(50)
  duration     Int?
  performedAt  DateTime           @default(now()) @map("performed_at") @db.Timestamptz(6)
  user         User               @relation(fields: [userId], references: [id])

  @@index([userId], map: "idx_user_actions_user_id")
  @@index([action], map: "idx_user_actions_action")
  @@index([category], map: "idx_user_actions_category")
  @@index([status], map: "idx_user_actions_status")
  @@index([performedAt], map: "idx_user_actions_performed_at")
  @@index([relatedId], map: "idx_user_actions_related_id")
  @@index([userId, performedAt], map: "idx_user_actions_user_performed")
  @@index([userId, category], map: "idx_user_actions_user_category")
  @@index([userId, action, status], map: "idx_user_actions_user_action_status")
  @@map("user_actions")
}

model UserTaxes {
  id                 String    @id @default(uuid()) @db.Uuid
  userId             String    @unique @map("user_id") @db.Uuid
  exchangeFeePercent Float     @default(0.3) @map("exchange_fee_percent")
  transferFeePercent Float     @default(0.1) @map("transfer_fee_percent")
  gasSubsidyEnabled  Boolean   @default(false) @map("gas_subsidy_enabled")
  gasSubsidyPercent  Float     @default(0) @map("gas_subsidy_percent")
  customFees         Json?     @map("custom_fees")
  isVip              Boolean   @default(false) @map("is_vip")
  vipLevel           Int       @default(0) @map("vip_level")
  validFrom          DateTime  @default(now()) @map("valid_from") @db.Timestamptz(6)
  validUntil         DateTime? @map("valid_until") @db.Timestamptz(6)
  metadata           Json?
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  depositFee         Float     @default(3.0) @map("deposit_fee")
  withdrawFee        Float     @default(5.0) @map("withdraw_fee")
  pixValidation      Float?    @default(1.0) @map("pix_validation")
  tokenTransferFees  Json?     @default("{\"DREX\": 1.0, \"cBRL\": 0.5}") @map("token_transfer_fees")
  user               User      @relation(fields: [userId], references: [id])

  @@index([userId], map: "idx_user_taxes_user_id")
  @@index([isVip], map: "idx_user_taxes_is_vip")
  @@index([vipLevel], map: "idx_user_taxes_vip_level")
  @@map("user_taxes")
}

model PasswordReset {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  token     String    @unique @db.VarChar(255)
  email     String    @db.VarChar(255)
  expiresAt DateTime  @map("expires_at") @db.Timestamptz(6)
  used      Boolean   @default(false)
  usedAt    DateTime? @map("used_at") @db.Timestamptz(6)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_password_resets_user_id")
  @@index([token], map: "idx_password_resets_token")
  @@index([expiresAt], map: "idx_password_resets_expires")
  @@index([email], map: "idx_password_resets_email")
  @@map("password_resets")
}

model UserBalance {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  balances  Json     @default("{}")
  stakes    Json     @default("{}")
  tokenData Json?    @map("token_data")
  network   Network  @default(testnet)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_user_balances_user_id")
  @@index([createdAt], map: "idx_user_balances_created_at")
  @@index([userId, createdAt(sort: Desc)], map: "idx_user_balances_user_date")
  @@index([network], map: "idx_user_balances_network")
  @@map("user_balances")
}

model NotificationConfig {
  id        String   @id @default(uuid()) @db.Uuid
  type      String   @unique @db.VarChar(50)
  userIds   Json     @default("[]") @map("user_ids")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([type], map: "idx_notification_config_type")
  @@map("notification_configs")
}

model WhatsAppMessage {
  id               String   @id @default(uuid()) @db.Uuid
  senderUserId     String   @map("sender_user_id") @db.Uuid
  recipientUserIds Json     @map("recipient_user_ids")
  recipientPhones  Json     @map("recipient_phones")
  message          String   @db.Text
  templateId       String?  @map("template_id") @db.VarChar(50)
  status           String   @default("sent") @db.VarChar(20)
  successCount     Int      @default(0) @map("success_count")
  failureCount     Int      @default(0) @map("failure_count")
  sentAt           DateTime @default(now()) @map("sent_at") @db.Timestamptz(6)
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([senderUserId], map: "idx_whatsapp_messages_sender")
  @@index([sentAt], map: "idx_whatsapp_messages_sent_at")
  @@index([templateId], map: "idx_whatsapp_messages_template")
  @@index([status], map: "idx_whatsapp_messages_status")
  @@map("whatsapp_messages")
}

model EmailLog {
  id           String    @id @default(uuid()) @db.Uuid
  templateId   String?   @map("template_id") @db.VarChar(100)
  fromEmail    String    @map("from_email") @db.VarChar(255)
  fromName     String?   @map("from_name") @db.VarChar(255)
  toEmail      String    @map("to_email") @db.VarChar(255)
  toName       String?   @map("to_name") @db.VarChar(255)
  subject      String    @db.VarChar(500)
  htmlContent  String?   @map("html_content") @db.Text
  textContent  String?   @map("text_content") @db.Text
  status       String    @default("pending") @db.VarChar(50)
  provider     String?   @db.VarChar(50)
  providerId   String?   @map("provider_id") @db.VarChar(255)
  metadata     Json?
  error        String?   @db.Text
  sentAt       DateTime? @map("sent_at") @db.Timestamptz(6)
  deliveredAt  DateTime? @map("delivered_at") @db.Timestamptz(6)
  openedAt     DateTime? @map("opened_at") @db.Timestamptz(6)
  clickedAt    DateTime? @map("clicked_at") @db.Timestamptz(6)
  bounced      Boolean   @default(false)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([toEmail], map: "idx_email_log_to_email")
  @@index([status], map: "idx_email_log_status")
  @@index([subject], map: "idx_email_log_subject")
  @@index([createdAt], map: "idx_email_log_created_at")
  @@map("email_logs")
}

enum Network {
  mainnet
  testnet
}

enum TransactionType {
  transfer
  contract_deploy
  contract_call
  contract_read
  deposit
  withdraw
  stake
  unstake
  exchange
  stake_reward
}

enum TransactionStatus {
  pending
  confirmed
  failed
  cancelled
}

enum UserPlan {
  BASIC
  PRO
  PREMIUM
}

enum UserDocumentType {
  front
  back
  selfie
}

enum UserDocumentStatus {
  not_sent
  pending
  approved
  rejected
}

enum TwoFactorType {
  totp
  sms
  email
  backup_codes
}

enum UserActionType {
  login
  logout
  login_failed
  password_reset
  password_changed
  two_factor_enabled
  two_factor_disabled
  two_factor_verified
  profile_updated
  profile_viewed
  document_uploaded
  document_verified
  deposit_initiated
  deposit_confirmed
  deposit_failed
  withdrawal_initiated
  withdrawal_approved
  withdrawal_completed
  withdrawal_failed
  transfer_sent
  transfer_received
  transfer_failed
  transaction_sent
  transaction_confirmed
  transaction_failed
  contract_interaction
  token_swap
  stake_created
  stake_withdrawn
  reward_claimed
  api_key_created
  api_key_deleted
  suspicious_activity
  account_locked
  account_unlocked
  notification_sent
  email_sent
  webhook_triggered
  cache_cleared
  user_created
  user_updated
  user_deleted
  permission_granted
  permission_revoked
  distributeReward
  registration_completed
}

enum UserActionCategory {
  authentication
  profile
  financial
  blockchain
  security
  system
  admin
}

enum UserActionStatus {
  success
  failed
  pending
  cancelled
}
